---
title: "Challenge: Discrimination in the EU"
author: "Mafalda González, David Pereiro, Irene Bosque y Pablo Aísa"
output: html_document
date: "2025-03-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

```{r}
library(tidyverse)
library(readxl)
library(haven)
library(patchwork)
library(scales)
library(countries)
library(showtext)
library(mice)
library(DataExplorer)
library(ggrepel)  
library(plotly)
library(rworldmap)
library(janitor)
library(car)
library(lme4)
library(ggplot2)
library(RColorBrewer)
library(caret)
library(rpart)
library(rpart.plot)
```

# Data cleaning

To analyse the effect of different country-level characteristics we have obtained data from the [World Bank](https://www.worldbank.org/ext/en/home), [ILGA Europe (Rainbow Map)](https://rainbowmap.ilga-europe.org/) and from the [Trans Rights Indicator Project by Harvard University](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/FXXLTS).

## Country-level variables

```{r}
# Religiosity-----------------------------------------------
religiosity <- read_dta("data/replication_data.dta")

religiosity <- religiosity |> 
  group_by(country_name) |> 
  slice_max(year) |> 
  ungroup()

religiosity <- religiosity |> 
  select(religiosity_percent, country_name)

religiosity <- religiosity |> 
  mutate(country = country_name(country_name, to = "simple", 
                                verbose = TRUE),
         country_iso = countrycode::countrycode(country, origin = "country.name",
                                                destination = "iso2c")) |> 
  select(country_iso, religiosity_percent)
```

```{r}
# Economic indicators---------------------------------------
economic_indicators <- read_xlsx("data/country_data.xlsx")

economic_indicators <- economic_indicators |> 
  drop_na(`Series Code`) 

economic_indicators <- economic_indicators %>%
  mutate(across(everything(), ~ str_remove_all(.x, "^\\.\\.$"))) %>%
  mutate(across(everything(), ~ if_else(.x == "", NA, .x)))

economic_indicators <- economic_indicators %>%
  mutate(latest_value = coalesce(`2023 [YR2023]`, 
                                 `2022 [YR2022]`, 
                                 `2021 [YR2021]`, 
                                 `2020 [YR2020]`)) |> 
  mutate(latest_value = as.numeric(latest_value))

economic_indicators <- economic_indicators |> 
  select(`Series Name`, `Country Name`, latest_value)

economic_indicators <- economic_indicators |> 
  pivot_wider(names_from = `Series Name`, values_from = latest_value )

economic_indicators <- economic_indicators |> 
  rename("country" = "Country Name", 
         "gini" = "Gini index",
         "gdp_pc" = "GDP per capita (constant 2015 US$)")

economic_indicators <- economic_indicators |> 
  mutate(country = country_name(country, to = "simple", 
                                verbose = TRUE),
         country_iso = countrycode::countrycode(country, 
                                                origin = "country.name",
                                                destination = "iso2c")) |> 
  select(country_iso, gini, gdp_pc)

economic_indicators <- economic_indicators |>
  add_row(country_iso = "MT", gini = 31.4, gdp_pc = 33000.6)
```

```{r}
# Trans laws------------------------------------------------

trans <-  read_csv("data/trans.csv")

trans <- trans |> 
  row_to_names(row_number = 1)

trans <- trans |> 
  clean_names() |> 
  select(2, 8) |> 
  drop_na(na_2) |> 
  rename("country" = "na_2")

trans <- trans |> 
  mutate(country = country_name(country, to = "simple", 
                                verbose = TRUE),
         country_iso = countrycode::countrycode(country, origin = "country.name",
                                                destination = "iso2c")) |> 
  select(country_iso, self_determination)
```

```{r}
# Rainbow score---------------------------------------------
rainbow <- read_csv("data/rainbow.csv")

rainbow <- rainbow |> 
  row_to_names(row_number = 1) |> 
  clean_names() |> 
  select(2, 3) |> 
  drop_na(na_2) |> 
  rename("country" = "na_2",
         "rain_ind" = "na_3") |> 
  mutate(rain_ind = as.numeric(rain_ind) / 100)

rainbow <- rainbow |> 
  mutate(country = country_name(country, to = "simple", 
                                verbose = TRUE),
         country_iso = countrycode::countrycode(country, origin = "country.name",
                                                destination = "iso2c")) |> 
  select(country_iso, rain_ind)

```

## Individual level variables from the survey

```{r}
survey <- read_dta("data/ZA7575.dta")

survey <- survey |> 
  select(caseid, serialid, isocntry, d10, d11, 
         d1, sd3, d7, sd1_4, sd1_7, sd1_8, d70,
         d63, qc19, d15a, d60, qc13_11, qc6_10, qc17_4)

# Recode dependent variable 
filtered_survey <- survey |> 
  mutate(trans_doc = case_when(
    qc19==1 ~ 1,
    qc19==2 ~ 0,
    qc19==3 ~ NA)) 

# Recode gender
filtered_survey <- filtered_survey |> 
  mutate(female = case_when(
    d10 == 1 ~ 0,
    d10 == 2 ~ 1,
    TRUE ~ NA),
    female = factor(female))

# Recode age
filtered_survey <- filtered_survey |> 
  mutate(age = if_else(d11 == 99 , NA, d11))

# Current occupation
filtered_survey <- filtered_survey |> 
  mutate(occupation = case_when(
    d15a %in% c(1, 3) ~ "Unemployed",
    d15a == 2 ~ "Student",
    d15a == 4 ~ "Retired",
    d15a <= 9 ~ "Self employed",
    d15a <=  18 ~ "Employed" ,
    TRUE ~ NA), 
    occupation = factor(occupation))

# Recode religion 
filtered_survey <- filtered_survey |> 
  mutate(religion = case_when(
    sd3 %in% c(1, 3, 4) ~ "Christians", 
    sd3 == 2 ~ "Orthodox Chrsitian", 
    sd3 %in% c(6, 7, 8) ~ "Muslims", 
    sd3 %in% c(5, 9, 10, 11, 14) ~ "Other religions", 
    sd3 %in% c(12, 13) ~ "Not religious", 
    TRUE ~ NA),
    religion = factor(religion))

# Marital status
filtered_survey <- filtered_survey |> 
  mutate(marital_status = case_when(
    d7 <= 4 ~ "Married",
    d7 <= 10 ~ "Single", 
    d7 <= 12 ~ "Divorced",
    d7 <=  14 ~ "Widowed",
    d7 == 15 ~ "Other", 
    TRUE ~ NA), 
    marital_status = factor(marital_status))

# Personal satisfaction
filtered_survey <- filtered_survey |> 
  mutate(personal_satis = if_else(d70 == 5, NA, d70),
         personal_satis = case_when(
           personal_satis <= 2 ~ "Satisfied",
           personal_satis > 2 ~ "Not satisfied"))

# Ideology
filtered_survey <- filtered_survey |> 
  mutate(ideology = if_else(d1 > 10, NA, d1)) 

# Contact LGBTQ+
filtered_survey <- filtered_survey |>  
  mutate(contact_lgbti = case_when(
    sd1_4 == 1 | sd1_7 == 1 | sd1_8 == 1 ~ "Contact", # There is contact
    sd1_4 == 2 | sd1_7 == 2 | sd1_8 == 2 ~ "No contact", # There is not contact
    TRUE ~ NA),
  contact_lgbti = factor(contact_lgbti))

# Self-perception of the social class
filtered_survey <- filtered_survey |> 
  mutate(social_class = case_when(
    d63 %in% c(1, 2) ~ "Working class", 
    d63 == 3 ~ "Middle class", 
    d63 %in% c(4, 5) ~ "High class", 
    TRUE ~ NA))

# Country names: DE-E and DE-W were problems 
filtered_survey <- filtered_survey |>  
  mutate(country = country_name(isocntry, to = "simple", 
                                verbose = TRUE, poor_matches = TRUE),
         isocntry = countrycode::countrycode(
           country, origin = "country.name", destination = "iso2c"))
  
individual_data <- filtered_survey |> 
  select(caseid, serialid, isocntry, trans_doc, female, age, religion, 
         marital_status, personal_satis, ideology, 
         contact_lgbti, social_class, occupation)
```

## Structural Cleaning and Final Merge 

Before merging all datasets and proceeding with the analysis, we conducted an initial assessment of their characteristics to verify data consistency and ensure a reliable analytical process.

```{r}
str(individual_data)
str(religiosity)
str(economic_indicators)
str(trans)
str(rainbow)
```

We observe some inconsistencies in two fo the data sets: individual_data and religiosity. The problem with the variables in these data sets is that they contain attributes, some are labeled doubles (dbl+lbl), some are not proper factors, etc. This will make working with the data, imputing it, making models as well as making predictions much harder. Hence, it is highly important to clean the data set structurally before continuing. 

We first proceed with the individual_data data set:

```{r}
individual_data <- individual_data %>%
  mutate(
    
    # labelled numerics => plain numeric
    across(where(~ inherits(., "haven_labelled")), ~ as.numeric(.)),
    
    # character variables => factors
    isocntry = as.factor(isocntry),
    personal_satis = as.factor(personal_satis),
    social_class = as.factor(social_class),

    # factor variables => proper factors
    trans_doc = factor(trans_doc),
    female = factor(female),
    contact_lgbti = factor(contact_lgbti),
    religion = factor(religion),
    marital_status = factor(marital_status),
    occupation = factor(occupation),
    
    # dbl+lbl => plain numeric 
    ideology = as.numeric(ideology),  
    age = as.numeric(age),
    
    # numeric variables => plain numeric
    caseid = as.numeric(caseid), 
    serialid = as.numeric(serialid),
    ) %>%
  
  # attributes 
  mutate(across(everything(), ~ {
    attr(., "label") <- NULL
    attr(., "format.stata") <- NULL
    attr(., "labels") <- NULL
    return(.)
  }))

str(individual_data)
```

And then we repeat the process for the religiosity data set:

```{r}
religiosity <- religiosity |> 
  mutate(across(everything(), ~{
    attr(.,"label") <- NULL
    attr(., "format.stata") <- NULL
    return(.)
  }))

```

Now, we can finally merge all the datasets using left_join: 

```{r}
# Final merge
data_descriptive <- individual_data |> 
  left_join(rainbow, by = c("isocntry" = "country_iso")) |> 
  left_join(trans, by = c("isocntry" = "country_iso")) |> 
  left_join(economic_indicators, by = c("isocntry" = "country_iso")) |> 
  left_join(religiosity, by = c("isocntry" = "country_iso"))
```

## Other interesting variables from the survey

```{r}

other_variables <- filtered_survey |> 
  select(isocntry, qc13_11, qc6_10, qc17_4)

# How comfortable you would feel if one of your children was in love with a trans person
other_variables <- other_variables |> 
  mutate(child_love = if_else(qc13_11 > 10, NA, qc13_11))

# Transgender person in a high political position
other_variables <- other_variables |>  
  mutate(trans_pol = if_else(qc6_10 > 10, NA, qc6_10))

# Information in schools about being transgender 
other_variables <- other_variables |> 
  mutate(trans_school = case_when(
    qc17_4 == 1 ~ "Totally agree",
    qc17_4 == 2 ~ "Tend to agree",
    qc17_4 == 3 ~ "Tend to disagree",
    qc17_4 == 4 ~ "Totally disagree",
    TRUE ~ NA),
    trans_school = factor(trans_school))

other_variables <- other_variables |> 
  mutate(country = country_name(isocntry, to = "simple", 
                                verbose = TRUE, poor_matches = TRUE),
         isocntry = countrycode::countrycode(
           country, origin = "country.name", destination = "iso2c"))
  
other_variables <- other_variables |> 
  select(child_love, trans_pol, trans_school, isocntry)
```


# Descriptive analysis

## Individual descriptive analysis

```{r}
plot_intro(data_descriptive)
```

Before diving into an in-depth analysis of the dataset, we first examine its key characteristics using this plot_intro. We observe that 55.6% of the dataset consists of discrete variables, while 44.4% are continuous. Additionally, 71.3% of the rows are complete, meaning they contain no missing values in any variable. The total percentage of missing values is minimal, accounting for just 2.1%.

```{r}
str(data_descriptive)
```

```{r}
summary(data_descriptive)
```

The dataset includes both individual-level variables, which capture personal characteristics and opinions, and country-level contextual variables, which help explain cross-country differences in support for transgender rights.

#### **Individual-Level Variables:**

These variables reflect personal attributes, experiences, and attitudes:

-   **serialid**: Unique identifier for each participant.

-   **isocntry**: Categorical variable distinguishing respondents by country (28 EU member states).

-   **trans_doc**: The key variable of this study, measuring attitudes toward the right of transgender individuals to officially change their name and gender. It is binary, with values of 0 (opposition) and 1 (support). In this dataset, 59.9% of participants expressed support.

-   **female**: 54.5% of the sample are women (14,946), while 45.5% are men (12,492).

-   **age**: Ranges from 15 to 98 years, with a median age of 53. The youngest 25% of respondents are aged 37 or younger, while the oldest 25% are 66 or older. This indicates a relatively older sample, which is relevant for analyzing attitudes, as previous studies have highlighted generational differences in the acceptance of LGBTI rights.

-   **religion**: captures respondents' religious affiliations, showing that a majority identify as Christian, with a smaller proportion reporting no religious affiliation.

-   **marital_status**: reflects participants’ relationship status, which may provide insight into how family experiences shape attitudes toward the transgender community.

-   **personal_satis**: Categorical variable representing personal life satisfaction, which could be linked to more open or restrictive attitudes.

-   **ideology**: A key political scale for analyzing ideological influence. Measured on a 1 to 10 scale, with a median of 5 and a mean of 5.3, suggesting a distribution centered around moderate positions.

-   **contact_lgbti**: assesses prior exposure to LGBTI individuals, an important factor in reducing prejudice, with a division between those who have had contact and those who have not.

-   **social_class**: Self-perceived social class, indicating the respondent’s socioeconomic context.

-   **occupation**: Employment status, allowing us to explore the influence of workplace environments.

#### **Country-Level Contextual Variables:**

In addition to individual-level factors, we incorporate aggregated national indicators to better understand how structural and policy differences influence support for transgender rights.

-   **rain_ind (Rainbow Index)**: Ranges from 17.5 %to 87.84%, with a mean of 50.08%. This index reflects the variation in LGBTI rights and protections across countries.

-   **self_determination**: Legal existence of gender self-determination. A qualitative variable that could influence support for transgender rights.

-   **gini**: Measures economic inequality at the national level and helps assess its impact on attitudes. Ranges from 24.1% to 39%, with a mean of 30.8%.

-   **gdp_pc (GDP per capita)**: Examines the relationship between economic development and attitudes.Ranges from \$9,820 to \$106,343, with a mean of \$34,577. The units are constant prices of 2015 in dollars to allow us to account for the inflation.

-   **religiosity_percent**: Percentage of the population that identifies as religious, which is crucial for exploring cultural and religious influences on attitudes.Values range from 21.49% to 100%, with a median of 81.16%.

```{r}
corr_data <- data_descriptive |> 
  select(trans_doc, age, ideology, rain_ind, gini, gdp_pc, religiosity_percent) |> 
  mutate(trans_doc = as.numeric(trans_doc))

corr_matrix <- cor(corr_data, use = "complete.obs")

plot_correlation(corr_matrix)

```

This correlation matrix highlights that support for transgender rights is significantly shaped by economic, cultural, and policy-related factors. Higher economic development, lower inequality, and strong LGBTI legal protections are associated with greater acceptance, while religiosity, conservatism, and age tend to correlate with lower support.

## Distribution of the individual variables

First of all, we proceed to analyze the distribution of the individual variables in our dataset:

```{r, fig.width=12}

# Religion
g1 <- ggplot(data_descriptive, aes(x = religion)) +
  geom_bar(aes(y = ..prop.., group = 1), fill = "#9C9EDE", color = "black") +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Religious identification", x = "Religion", y = "Percentage") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_text(size = 12, face = "bold")) +
  theme_minimal()

# Marital status
g2 <- ggplot(data_descriptive, aes(x = marital_status)) +
  geom_bar(aes(y = ..prop.., group = 1), fill = "#98DF8A", color = "black") +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Marital status distribution", x = "Status", y = "Percentage") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_text(size = 12, face = "bold")) +
  theme_minimal()

# Personal satisfaction
g3 <- ggplot(data_descriptive, aes(x = personal_satis)) +
  geom_bar(aes(y = ..prop.., group = 1), fill = "#FF9896", color = "black") +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Personal Satisfaction", 
       x = "Response", y = "Percentage") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_text(size = 12, face = "bold")) +
  theme_minimal()

# Social class
g4 <- ggplot(data_descriptive, aes(x = social_class)) +
  geom_bar(aes(y = ..prop.., group = 1), fill = "#9EDAE5", color = "black") +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Self-reported social slass", x = "Social class", y = "Percentage") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_text(size = 12, face = "bold")) +
  theme_minimal()

#Occupation

g5 <- ggplot(data_descriptive, aes(x = occupation)) +
  geom_bar(aes(y = ..prop.., group = 1), fill = "yellow", color = "black") +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Occupation distribution", x = "Occupation", y = "Percentage") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_text(size = 12, face = "bold")) +
  theme_minimal()

# Contact with LGTB community

g6 <- ggplot(data_descriptive, aes(x = contact_lgbti)) +
  geom_bar(aes(y = ..prop.., group = 1), fill = "darkblue", color = "black") +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Contact with the LGTBI community", x = "Response", y = "Percentage") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_text(size = 12, face = "bold")) +
  theme_minimal()

# Graphs combined
g <- (g1 | g2 | g3) / (g4 | g5 | g6) 
g

```

One of the first aspects to analyze is the distribution of categorical variables in the dataset, which, as previously noted, account for 55.6% of the total data. The set of bar charts provides an overview of key individual characteristics, highlighting patterns in religious identification, marital status, personal satisfaction, social class, occupation, and contact with the LGBTI community.

The majority of respondents identify as Christian, while a notable percentage report no religious affiliation, and smaller proportions belong to other religious groups such as Muslims and Orthodox Christians. In terms of marital status, the most represented group consists of married individuals, followed by single respondents, while divorced and widowed participants form smaller segments of the sample.

Regarding personal satisfaction, a significant majority report being satisfied with their lives, whereas only a small minority express dissatisfaction. The self-reported social class distribution indicates that most respondents identify as middle or working class, while a much smaller portion considers themselves part of the high class. Similarly, the occupation distribution reveals that most individuals are either employed or retired, while students, the self-employed, and the unemployed represent smaller proportions.

Finally, contact with the LGBTI community reveals a notable divide, with a substantial portion of respondents reporting no contact with LGBTI individuals, while a significant number indicate prior interaction. This variable is particularly relevant, as previous research suggests that personal exposure to LGBTI individuals can influence attitudes toward their rights. 

```{r}
ggplot(data_descriptive, aes(x = age)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "steelblue", alpha = 0.6) +
  geom_density(color = "red", linewidth = 1) +
  theme_minimal() +
  labs(title = "Age Distribution", x = "Age", y = "Density")

```

Next, we observe the age distribution of the respondents in the dataset. The distribution appears right-skewed, indicating that there are fewer younger participants and a greater proportion of middle-aged and older respondents. The density increases gradually, peaking around 50 to 70 years old, before sharply declining beyond 75 years.The smoother density curve (red line) confirms the overall trend, highlighting multiple local peaks, particularly around 30, 50, and 70 years old, before declining toward the upper age limit of the sample.

Overall, the distribution supports the earlier summary statistics, where the median age was reported at 53 years, with the youngest quartile at 37 years or younger and the oldest quartile at 66 years or older. The relatively low representation of younger individuals could influence the overall attitudinal patterns observed in the study.


## Variable Distribution by Country

Next, we analyze the contextual differences between the countries surveyed in the dataset.

```{r}
#Contact with LGTBI community by country
country_order <- data_descriptive %>%
  filter(!is.na(contact_lgbti)) %>%
  group_by(isocntry) %>%
  summarise(no_contact_prop = mean(contact_lgbti == "No contact")) %>%
  arrange(desc(no_contact_prop))


ggplot(data_descriptive, aes(x = factor(isocntry, levels = country_order$isocntry), fill = contact_lgbti)) +
  geom_bar(position = "fill") +
  theme_minimal() +
  labs(title = "Contact with LGTBI community by country", 
       x = "Country", y = "Percentage") +
  scale_fill_manual(values = c("Contact" = "olivedrab3", "No contact" = "red2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}

data_country <- data_descriptive |> 
  filter(!is.na(contact_lgbti)) |> 
  group_by(isocntry) |> 
  summarise(no_contact_prop = mean(contact_lgbti == "No contact")) |> 
  mutate(contact_category = ifelse(no_contact_prop < 0.5, "Majority Contact", "Majority No Contact"))

map_data <- joinCountryData2Map(data_country, joinCode = "ISO2", nameJoinColumn = "isocntry")

color_palette <- c("Majority Contact" = "olivedrab3", "Majority No Contact" = "red2")

mapCountryData(map_data, 
               nameColumnToPlot = "contact_category", 
               mapTitle = "Predominance of Contact with the LGBTI Community by Country",
               catMethod = "categorical",
               colourPalette = color_palette,
               mapRegion = "Europe")

```

These two visualizations illustrate the distribution of contact with the LGBTI community across countries, highlighting significant regional differences in social exposure to LGBTI individuals.

The first bar chart presents the proportion of respondents in each country who report having contact with LGBTI individuals (green) versus those who do not (red), with a small portion of missing responses (gray). Countries are arranged from left to right based on decreasing levels of respondents lacking contact with the LGBTI community. Romania, Bulgaria, Poland, and several other Eastern European countries show the highest levels of non-contact, while the Netherlands, Sweden, and other Western and Northern European nations report the highest levels of contact. This suggests a strong regional divide in familiarity with LGBTI individuals.

The second map visually reinforces this divide, categorizing countries based on whether a majority of respondents reported having contact with the LGBTI community. Western and Northern European countries (in green) generally show higher exposure with the exception of Portugal, while Eastern and Southern European countries (in red) report lower levels of contact.

```{r}
western_northern <- c("AT", "BE", "DK", "FI", "FR", "DE", "IE", "IS", "LU", "NL", "NO", "SE", "CH", "ES", "PT", "IT", "GB", "MT")
eastern <- c("BG", "CZ", "EE", "HU", "LT", "LV", "PL", "RO", "RU", "SK", "SI", "HR", "UA", "GR", "CY")

data_descriptive$region <- case_when(
  data_descriptive$isocntry %in% western_northern ~ "Western/Northern",
  data_descriptive$isocntry %in% eastern ~ "Eastern",
  TRUE ~ "Other"
)

ggplot(data_descriptive, aes(x = gdp_pc, y = rain_ind, label = isocntry)) +
  geom_point(aes(color = region), size = 4, shape = 21, stroke = 1, fill = "white") +  
  geom_text(size = 3, hjust = 1.6)  + 
  theme_minimal() +
  labs(
    title = "GDP per capita vs Rainbow Indicator per Country",
    x = "GDP per capita",
    y = "Rainbow Indicator",
    color = "Region"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    legend.position = "top")
```



```{r}
ggplot(data_descriptive, aes(x = religiosity_percent, y = rain_ind, label = isocntry)) +
  geom_point(aes(color = case_when(
    isocntry %in% western_northern ~ "Western/Northern",
    isocntry %in% eastern ~ "Eastern",
    TRUE ~ "Other")), size = 4, shape = 21, stroke = 1, fill = "white") +  
  geom_text(size = 3, hjust = -0.6) +  
  scale_color_manual(values = c("Western/Northern" = "royalblue", "Eastern" = "red3", "Other" = "gray")) + 
  theme_minimal(base_size = 14) +
  labs(
    title = "Religiosity Percentage vs Rainbow Indicator per Country",
    x = "Religiosity Percentage",
    y = "Rainbow Indicator",
    color = "Region"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    legend.position = "top")

```


```{r}
#Distribution of the Political Ideology by Country

ggplot(data_descriptive, aes(x = reorder(isocntry, ideology, FUN = median, na.rm = TRUE), y = ideology, fill = isocntry)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Distribution of the Political Ideology by Country", 
       x = "Country", y = "Ideology (1 = Left, 10 = Right)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +  
   scale_fill_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(28))
  

```
This boxplot visualization illustrates the distribution of political ideology across countries, measured on a 1 to 10 scale, where 1 represents left-wing views and 10 represents right-wing views. The countries are arranged from left to right based on their median ideological positioning, with lighter shades representing more left-leaning countries and darker shades indicating more right-leaning ones.

Almost every Western and Northern European countries, such as Austria (AT), Belgium (BE), Denmark (DK), and Finland (FI), show a more center median ideology, with a broader distribution of responses. In contrast, Eastern and Southern European countries, including Slovakia (SK), Hungary (HU), Latvia (LV), and Romania (RO), display higher median scores, indicating a more right-leaning population. 

However, Spain is particularly interesting because, although its median ideology is similar to that of many other countries, the overall distribution is skewed to the left, meaning a larger proportion of respondents identify as left-wing compared to right-wing. This suggests that while the central tendency remains balanced, there is a stronger leftist presence in the country.

In contrast, some countries like the Czech Republic (CZ), Cyprus (CY), and Estonia (EE) exhibit the opposite trend. Their median scores remain relatively moderate, yet the distribution skews towards the right, implying a larger proportion of right-leaning individuals compared to left-leaning ones. 


## Bivariate Analysis with Target Variable

```{r}

data_country <- aggregate(as.numeric(trans_doc) ~ isocntry, data = data_descriptive, mean, na.rm = TRUE)

map_data <- joinCountryData2Map(data_country, joinCode = "ISO2", nameJoinColumn = "isocntry")

mapCountryData(map_data, 
               nameColumnToPlot = "as.numeric(trans_doc)", 
               mapTitle = "Support for change of Documents of the Trans Community per Country", 
               catMethod = "quantiles", 
               colourPalette = brewer.pal(9, "Blues"), 
               mapRegion = "Europe")

```

This choropleth map illustrates the level of support for transgender individuals' right to change their official documents, our target variable, across different European countries. The color gradient, ranging from light blue (low support) to dark blue (high support), visually represents the variation in attitudes toward this issue.

Western and Northern European countries, such as Spain, Portugal, the Netherlands, Belgium, and the Nordic countries, exhibit the highest levels of support, as indicated by the darkest shades of blue. This pattern aligns with broader trends of progressive LGBTI policies and strong legal protections in these regions. France and Germany show similarly high levels of support, though not as strong. 

In contrast, Central and Eastern European countries, including Poland, Hungary, and several Balkan states, show significantly lower levels of support, as reflected by the lighter shades. These countries tend to have more conservative social attitudes and restrictive legal frameworks regarding transgender rights. Italy stands out with surprisingly low support compared to other Western European nations. This suggests that despite being a major Western European country, Italy remains more conservative on transgender issues.

```{r}
ggplot(data_descriptive, aes(x = as.factor(trans_doc), y = ideology, fill = as.factor(trans_doc))) + 
  geom_boxplot(alpha = 0.6) + 
  theme_minimal() + 
  labs(title = "Political Ideology vs Support Trans Documents", 
       x = "Support for the change of Documents of the Trans Community", 
       y = "Ideology (1 = Left, 10 = Right)") + 
  scale_fill_manual(values = c("0" = "red2", "1" = "olivedrab3")) + 
  scale_x_discrete(labels = c("0" = "No", "1" = "Yes")) + 
  theme(legend.position = "none")

```

```{r}
ggplot(data_descriptive, aes(x = as.factor(trans_doc), y = religiosity_percent, fill = as.factor(trans_doc))) +
  geom_boxplot(alpha = 0.6) +
  theme_minimal() +
  labs(title = "Religiosity vs Support Trans Documents", 
       x = "Support for the change of Documents of the Trans Community", 
       y = "Percentage of Religiosity") + 
  scale_fill_manual(values = c("0" = "red2", "1" = "olivedrab3")) + 
  scale_x_discrete(labels = c("0" = "No", "1" = "Yes")) + 
  theme(legend.position = "none")

```
These two boxplots examine the relationship between support for transgender individuals' right to change their official documents and two factors: political ideology and religiosity. 

In the first boxplot (Political Ideology vs. Support for Trans Documents), the median ideology score is similar across groups, meaning that those who support (green) and oppose (red) document changes have roughly the same central tendency. However, a key difference emerges in the distribution of responses: those who oppose the right to change documents have a longer right-leaning tail, indicating a higher presence of strongly right-wing individuals in this group. In contrast, supporters have a more centralized distribution, meaning they are not necessarily strongly left-wing, but rather clustered around moderate-left to centrist views. The NA category (gray) also has a similar median but a broader spread, covering both left- and right-leaning respondents more evenly.

The second boxplot (Religiosity vs. Support for Trans Documents) presents a slightly different pattern. Here, the median religiosity score is slightly higher for those who oppose document changes compared to supporters. However, unlike political ideology, the distribution of religiosity is more similar across groups, meaning that while opposition to trans rights is somewhat more frequent among more religious individuals, this is not highly significant

In summary, while there are some observable differences in political ideology and religiosity between those who support or oppose transgender rights, they are not highly significant. The distributions indicate that attitudes toward transgender document changes are influenced by multiple factors, with ideology and religiosity playing a role but not being the sole determinants.

## Other variables related to transgender persons

```{r}
# Boxplot 1: trans_child
b1 <- ggplot(other_variables, 
             aes(x = reorder(isocntry, child_love, FUN = median, decreasing = TRUE), 
                                  y = child_love)) +
  geom_boxplot(fill = "#FFBB78", outlier.colour = "red", outlier.fill = "red") +
  labs(title = "How comfortable would you feel if one of your children was in love with a trans person?", 
       x = "Country", y = "Support Level") +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 1),
    axis.title = element_text(size = 12, face = "bold")) +
  theme_minimal()


# Boxplot 2: trans_pol
b2 <- ggplot(other_variables, 
             aes(x = reorder(isocntry, trans_pol, FUN = median, decreasing = TRUE), 
                                  y = trans_pol)) +
  geom_boxplot(fill = "#AEC7E8", outlier.colour = "red", outlier.fill = "red") +
  labs(title = "Trans people in high political positions", 
       x = "Country", y = "Support Level") +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 1),
    axis.title = element_text(size = 12, face = "bold")) +
  theme_minimal()

# Boxplots combined
b <- b1 / b2 
b
```

# Mice imputation

Before continuing to the models we take a look at missing values in the original Eurobarometer dataset and the possibility to impute them. We did the descriptive analysis without previous imputation as we perceived that descriptive makes only sense with the original dataset and the real values we know to be true. 

First, we take a look at the NA distribution of the Eurobarometer dataset. 

```{r}
colSums(is.na(individual_data))
```

The variables with most missing values are ideology, with 4689 NAs, which supposes a 17% of missing data within the variable (5689/27438), and social_class, with 1021 NAs, making up 21% of the variable (5883/27438). Religion has 483 NAs and contact_lgbti has 494 NAs. trans_doc has 3280 NAs, but we will not impute it as it is our target variable. The variables marital_status and personal_satis have 68 and 102 NAs respectively. Due to the low number we can go ahead and simply remove the rows. We remove caseid and serialid as it could confuse our mice imputation. 

```{r}
mice_data <- individual_data %>% 
  drop_na(c(marital_status, personal_satis)) %>% 
  select(-c(caseid))

serialid <- mice_data$serialid

mice_data <- mice_data %>% 
  select(-c(serialid))

colSums(is.na(mice_data))

```
We are left with 4599 NAs for ideology, 472 NAs for contact_lgbti, 448 NAs for religion and 973 NAs for social class. 

First, we are going to manually look at the different imputation methods and strategies to understand how close they come to the original dataset. 
As there are factor and numerical variables, the best options to test tje imputation are Random Forest and Pmm methods.

```{r}
imputed_comparison <- data.frame(
  original = mice_data$ideology,
  imputed_rf = complete(mice(mice_data, method = "rf", 
                             m = 3, maxit = 3, 
                             seed = 123))$ideology,
  imputed_pmm = complete(mice(mice_data, method = "pmm",
                              m = 3, maxit = 3, 
                              seed = 123))$ideology)
```

The m and the maxit arguments are = 3 to reduce loading time without losing so much information.

The next step is to plot the results to compare the resulting distributions: 

```{r}
# Arguments for the plot 
methods <- c("original", "imputed_rf" , "imputed_pmm")
titles <- c("Distribution of the Age Variable",
           "Random Forest-imputed Distribution",
            "PMM-imputed Distribution")
colors_fill <- c( "#E7CB94", "#E7969C", "#DE9ED6")


# Long format 
data_imputed_long <- imputed_comparison |>
  pivot_longer(cols = all_of(methods), names_to = "method", 
                values_to = "value") |>
  mutate(title = factor(method, levels = methods, labels = titles))


# Distributions comparison 
plot_mice <- ggplot(data_imputed_long, aes(x = value, fill = title)) +
  geom_histogram(binwidth = 1, color = "black", position = "identity") +
  facet_wrap(~ title, scales = "free_y") +
  scale_fill_manual(values = colors_fill) +
  theme_classic() +
  theme(legend.position = "none")

plot_mice
```

TODO: short interpretation 

Now, we go ahead with the imputation of the complete dataset. We use m = 3, as our missing values range between 5% and 20% of the observations. Hence, m=3 is still powerful enough to have reasonable imputation. 

```{r}
init = mice(mice_data, m = 3, seed = 123)
```

For our target variable trans_doc we set method="", so that it is not imputed. 

```{r}
meth = init$method

meth

meth[c("trans_doc")]=""

imputed_data = mice(mice_data, method=meth, m=3, seed=123)
```

```{r}
summary(imputed_data)
```

## Merging datasets again

For modeling, the best would be to use the function `with()` and all 3 generated datasets of mice, which would give us a better result but also take more time. Due to practicality and the point of the exercise not being focused on perfect mice usage, we take the decision of extracting and keep working with only one of the datasets. 

```{r}
imputed_data_complete <- complete(imputed_data)

write.csv(imputed_data_complete, "imputed_data_complete.csv")
# my_data <- read.csv("imputed_data_complete.csv")

```

```{r}
data <- imputed_data_complete |> 
  left_join(rainbow, by = c("isocntry" = "country_iso")) |> 
  left_join(trans, by = c("isocntry" = "country_iso")) |> 
  left_join(economic_indicators, by = c("isocntry" = "country_iso")) |> 
  left_join(religiosity, by = c("isocntry" = "country_iso"))

```

# Explaining Cross-Country Differences

First of all, we performed a brief data preparation to enhance stability and model performance. First, we transformed GDP per capita with a natural logarithm to reduce the asymmetry of its distribution and make nonlinear relationships with other variables more manageable. Then, we reassigned the reference level of the categorical variable on contact with LGBTI people, setting "No contact" as the base category.

```{r}
data <- data |> 
  mutate(gdp_pc = log(gdp_pc))

data$contact_lgbti <- relevel(data$contact_lgbti, ref = "No contact")

str(data)

```

Then, we check for the multicollinearity in our model:

```{r}
model <- glm(trans_doc ~ scale(age) + 
               female + 
               religion + 
               occupation + 
               marital_status + 
               personal_satis +
               contact_lgbti +
               scale(ideology) +
               social_class +
               scale(gdp_pc) +
               self_determination + 
               scale(gini) + 
               scale(rain_ind) + 
               scale(religiosity_percent), 
             family = "binomial", data = data)

summary(model)

exp(coef(model))

vif(model) 
```

We use the Variance Inflation Factor (VIF) to identify highly correlated predictor variables. In the results, the GVIF values indicate that the multicollinearity is not problematic, as most VIFs are below 2. This suggests there is no significant multicollinearity between the individual variables and collective variables, ensuring reliable coefficient estimates and proper interpretation of each variable’s effect.

Next, we test different models to identify key factors influencing support for transgender individuals' right to decide on their own document.

```{r}
model2 <- glmer(trans_doc ~ 
                  scale(age) + 
                  female + 
                  religion +
                  occupation +
                  marital_status + 
                  personal_satis +
                  contact_lgbti +
                  scale(ideology) +
                  social_class +
                  (1|isocntry), 
                family = "binomial", 
                data = data)
summary(model2)


model3 <- glmer(trans_doc ~ 
                  scale(age) + 
                  I(scale(age)^2) +
                  female + 
                  occupation +
                  religion*scale(religiosity_percent) + 
                  marital_status*scale(religiosity_percent) + 
                  personal_satis*self_determination +
                  contact_lgbti*scale(rain_ind) +
                  contact_lgbti*self_determination +
                  scale(ideology)*scale(gdp_pc) +
                  social_class*scale(gini) +
                  (1|isocntry), 
                family = "binomial", 
                data = data)
summary(model3)
```

We started with model2, a generalized linear mixed-effects model that includes a random intercept for each country to account for country-specific variation. Then, we tried model3, a more complex model that includes interaction terms (e.g., religion and religiosity, marital status and religiosity) to capture more nuanced relationships. Some variables like age, self-determination, and GDP per capita were not significant on their own, but interactions like religion and marital status showed relevance. 

In model4, we extended the complexity further by adding additional interaction terms and quadratic terms, similar to model3. This model includes interactions like religion and religiosity percent, personal satisfaction and self-determination, and contact with LGBTI people with variables such as rain index and self-determination. We also included the interaction between ideology and GDP per capita and social class with the Gini index.

```{r}
model4 <- glmer(trans_doc ~ 
                  scale(age) + 
                  I(scale(age)^2) + 
                  female + 
                  religion +
                  occupation + 
                  religion:scale(religiosity_percent) + 
                  marital_status + 
                  personal_satis + 
                  personal_satis:self_determination +
                  contact_lgbti*scale(rain_ind) +
                  contact_lgbti:self_determination +
                  scale(ideology) +
                  scale(ideology):scale(gdp_pc) +
                  social_class*scale(gini) +
                  (1|isocntry), 
                family = "binomial", 
                data = data)
summary(model4)

```

However, after reviewing the results, we found that certain variables, such as self-determination, personal satisfaction, Gini, and social class, were not significant. 

In model5, we included additional variables and interactions, while also refining the previous interactions. This model examines the impact of variables like age, gender, religion, occupation, and their interactions, such as religion with religiosity percentage, contact with LGBTI people with rain index, and ideology with GDP per capita.

```{r}
model5 <- glmer(trans_doc ~ 
                  scale(age) +
                  I(scale(age) ^ 2) + 
                  female + 
                  occupation + 
                  religion +
                  religion:scale(religiosity_percent) + 
                  marital_status + 
                  personal_satis +
                  contact_lgbti*scale(rain_ind) +
                  contact_lgbti:self_determination +
                  ideology + 
                  ideology:scale(gdp_pc) +
                  social_class +
                  scale(gini) +
                  (1|isocntry), 
                family = "binomial", 
                data = data)
summary(model5)

```

Similar to the previous results, we found that Gini, contact with LGBTI people, self-determination, and social class were not significant.

In model6, we further refined the model by removing non-significant variables from previous iterations, resulting in a more streamlined approach

```{r}
model6 <- glmer(trans_doc ~ 
                  scale(age) +
                  I(scale(age) ^ 2) + 
                  female + 
                  occupation +
                  religion +
                  religion:scale(religiosity_percent) + 
                  marital_status + 
                  personal_satis +
                  contact_lgbti*scale(rain_ind) +
                  ideology + 
                  ideology:scale(gdp_pc) +
                  (1|isocntry), 
                family = "binomial",
                data = data)
summary(model6)
```

After evaluating the results, we found that marital status was not significant in predicting support for transgender rights.

In model7, we further simplified the model by removing marital status based on the previous findings.
```{r}
model7 <- glmer(trans_doc ~ 
                  scale(age) +
                  I(scale(age) ^ 2) + 
                  female + 
                  occupation +
                  religion +
                  religion:scale(religiosity_percent) + 
                  personal_satis +
                  contact_lgbti*scale(rain_ind) +
                  ideology + 
                  ideology:scale(gdp_pc) +
                  (1|isocntry), 
                family = "binomial", 
                data = data)
summary(model7)
```

In model8, we introduced random slopes alongside random intercepts. Specifically, we modeled age, gender (female), and ideology as having random slopes by country. The random intercepts allow for country-specific baselines, and the random slopes allow us to capture how the relationships between these predictors and the target variable may differ between countries.

```{r}
model8 <- glmer(trans_doc ~ 
                  scale(age) +
                  I(age ^ 2) + 
                  female + 
                  occupation +
                  religion +
                  religion:scale(religiosity_percent) + 
                  personal_satis +
                  contact_lgbti*scale(rain_ind) +
                  ideology + 
                  ideology:scale(gdp_pc) +
                  (1 + scale(age) + female + scale(ideology)|isocntry), 
                family = "binomial", 
                data = data)
summary(model8)

ranef(model8) |>  # This is for extracting random intercepts and slopes
  str()
```

The random effects output shows how intercepts and slopes vary by country. The (Intercept) column represents country-specific deviations from the overall intercept. The scale(age), female1, and scale(ideology) columns indicate how these predictors' effects differ across countries. The values suggest small but varying influences of age, gender, and ideology on the target variable, depending on the country.

In step_model, we continued refining the model by incorporating both age and its squared term (age^2). The rationale behind this is that the linear term (age) and the quadratic term (age^2) work together to model a curvilinear relationship. Even though age itself may not be significant, we retain it in the model because the combined effect of both terms allows for capturing a potential non-linear relationship with the target variable. This helps to better model the relationship between age and support for transgender rights.

The model includes additional predictors like female, occupation, and religion interactions with religiosity_percent, along with other interaction terms such as contact_lgbti with rain index and ideology with GDP per capita. We also kept the random slopes for age, female, and ideology across countries, as these allow the effects of these variables to vary by country.

```{r}
step_model <- glmer(trans_doc ~ 
                  scale(age) + 
                  I(scale(age)^2) +
                  female + 
                  occupation +
                  religion*scale(religiosity_percent) + 
                  marital_status*scale(religiosity_percent) + 
                  personal_satis*self_determination +
                  contact_lgbti*scale(rain_ind) +
                  contact_lgbti*self_determination +
                  scale(ideology)*scale(gdp_pc) +
                  social_class*scale(gini) +
                  (1 + scale(age) + 
                     female +
                     scale(ideology)
                     |isocntry), 
                family = "binomial",
                data = data)

summary(step_model)
```

The results showed that age (quadratic), gender, occupation, personal satisfaction, contact with LGBTI people, and ideology were relevant predictors. Additionally, interactions between religion and religiosity, as well as ideology and GDP, played a significant role. However, variables like marital status, social class, and the Gini index were not significant, leading to their exclusion in the final model:

```{r}
final_model <- glmer(trans_doc ~ 
                      scale(age) + 
                      I(scale(age)^2) +
                      female + 
                      occupation +
                      religion*scale(religiosity_percent) +  
                      personal_satis +
                      contact_lgbti*scale(rain_ind) +
                      self_determination +
                      scale(ideology)*scale(gdp_pc) +
                      (1 + scale(age) + 
                         female +
                         scale(ideology)
                       |isocntry), 
                    family = "binomial",
                    data = data)

summary(final_model)

lme4::ranef(final_model) %>% 
  str 
```

In final_model, we have refined the model to include both age and its squared term (age^2), maintaining them together to model a curvilinear relationship between age and the target variable. 

This final_model is chosen over the step_model, despite having a higher AIC, because the step_model reduces this metric spuriously by eliminating variables that, although not individually significant, contribute theoretical coherence and explanatory value to the model. Over-simplification can falsely improve the AIC without actually leading to a better fit.

Regarding the results, support for trans rights is influenced by several factors. Being a woman significantly increases support, while age has a curvilinear effect, with a decline at older ages. Being retired reduces support, and religiosity also plays a role, particularly in some religious groups where lower acceptance is observed. In contrast, being non-religious is associated with a more favorable stance. Personal satisfaction and contact with LGBTI individuals have strong positive and highly significant effects, suggesting that social interaction strongly shapes attitudes. Additionally, while a more conservative ideology decreases support, this effect is moderated by the country’s GDP per capita.

In terms of random effects, there is variation between countries in the intercept and in the slopes of age, gender, and ideology, indicating that these factors do not influence attitudes in the same way across national contexts. Overall, the model confirms that support for trans rights is a multifaceted phenomenon shaped by both individual and structural factors.

# Predictive models

For the predictive part of the model we are going to try the predictive capability of our explanatory model and after that we will try some machine learning techniques as K-nearest neighbours, decision trees and random forest.

We will have two type of training and testing sets. The first one is going to be used in the prediction with the explanatory model and the knn and it will consist in a training set that will contain 70% of the data of each country and in a testing set that will have 30% of the data of each country. The reason behind this splitting is that in the explanatory model we will have random intercept and slopes for each country and in the knn is because it does not admit new levels.

The second set will follow the same 70/30 structure but with a crucial difference—it will leave out one country entirely. This approach allows us to evaluate whether the models can generalize effectively to completely unseen datasets, providing a more robust test of their predictive performance.

```{r}
set.seed(123)

# reinsert serialid to be able to pinpoint observations 
data$serialid <- serialid 

# training and testing set 
training <- data %>%
  group_by(isocntry) %>%
  sample_frac(0.7) %>%
  ungroup()

testing <- data %>%
  anti_join(training, by = c("serialid")) 

# remove serialid from the model dataset
training <- training %>%
  select(-serialid)

testing <- testing  %>%
  select(-serialid) 

# training model 
final_model <- glmer(trans_doc ~ 
                       scale(age) + 
                       I(scale(age)^2) +
                       female + 
                       occupation +
                       religion*scale(religiosity_percent) +  
                       personal_satis +
                       contact_lgbti*scale(rain_ind) +
                       self_determination +
                       scale(ideology)*scale(gdp_pc) +
                       (1  + scale(age) +
                          female +
                          scale(ideology)
                        |isocntry), 
                     family = binomial(link = "logit"),
                     control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)),
                     data = training)

summary(final_model)

# complete cases 
training <- training[complete.cases(training), ]
testing <- testing[complete.cases(testing), ]

# prediction
pred <- predict(final_model, newdata = testing, type = "response")

# pred() worked: 
prediction <- as.factor(ifelse(pred > 0.5, 1, 0))

# final: 
confusionMatrix(prediction, testing$trans_doc)
confusionMatrix(prediction, testing$trans_doc)$overall[1:2]


```

We obtain a pretty good accuracy 

# K-NN

```{r}
ctrl <- trainControl(method = "repeatedcv", 
                     number = 5,
                     classProbs = T,
                     summaryFunction=twoClassSummary,
                     verboseIter = T)

training <- as.data.frame(training)

training$isocntry <- factor(training$isocntry)
testing$isocntry <- factor(testing$isocntry)

training <- training |> 
  mutate(trans_doc = case_when(
    trans_doc == "1" ~ "Yes",
    trans_doc == "0" ~ "No",
    TRUE ~ NA),
    trans_doc = factor(trans_doc))

testing <- testing |> 
  mutate(trans_doc = case_when(
    trans_doc == "1" ~ "Yes",
    trans_doc == "0" ~ "No",
    TRUE ~ NA),
    trans_doc = factor(trans_doc))

str(training)
knnFit <- train(trans_doc ~ ., 
                data = training,
                method = "kknn",   
                preProc=c('scale','center'),
                tuneLength = 10,
                metric="ROC",
                trControl = ctrl)

knnProb <- predict(knnFit, testing, type="prob", )
prediction <- as.factor(ifelse(knnProb[,2] > 0.5, "Yes", "No"))


confusionMatrix(prediction, testing$trans_doc)$table
confusionMatrix(prediction, testing$trans_doc)$overall[1:2]
```
This model has a little worst accuracy than the our explanatory model.

## Decision trees

From now on, we will do not have Finland in the training set.

```{r}
# Separate Finland as our test country 
data$serialid <- serialid 

no_fi <- data |> 
  filter(isocntry != "FI") |> 
  mutate(trans_doc = case_when(
    trans_doc == "1" ~ "Yes",
    trans_doc == "0" ~ "No",
    TRUE ~ NA
  ))

test_country_fi <- data |> 
  filter(isocntry == "FI")|> 
  mutate(trans_doc = case_when(
    trans_doc == "1" ~ "Yes",
    trans_doc == "0" ~ "No",
    TRUE ~ NA
  ))

# training and testing set 
training2 <- no_fi %>%
  group_by(isocntry) %>%
  sample_frac(0.7) %>%
  ungroup()

test_no_fi <- no_fi %>%
  anti_join(training2, by = c("serialid"))  

testing2 <- test_no_fi |> 
  bind_rows(test_country_fi)

# remove serialid from the model dataset
training2 <- training2 %>%
  select(-c(serialid, isocntry))

testing2 <- testing2  %>%
  select(-c(serialid, isocntry)) 

test_country_fi <- test_country_fi |> 
  select(-c(serialid, isocntry)) 

```

```{r}
training2 <- training2[complete.cases(training2), ]
testing2 <- testing2[complete.cases(testing2), ]
test_no_fi <- test_no_fi[complete.cases(test_no_fi), ]
test_country_fi <- test_country_fi[complete.cases(test_country_fi), ]
```

```{r}
training2$trans_doc <- as.factor(training2$trans_doc)

training2 <- as.data.frame(training2)

control <- rpart.control(minsplit = 30, maxdepth = 10, cp=0.01)

model <- trans_doc ~ .
dtFit <- rpart(model, data=training2, method = "class", control = control)
summary(dtFit)


rpart.plot(dtFit, digits=3)

dtPred <- predict(dtFit, testing2, type = "class")

dtProb <- predict(dtFit, testing2, type = "prob")

prediction <- as.factor(ifelse(dtProb[,2] > 0.5, "Yes", "No"))

testing2$trans_doc <- factor(testing2$trans_doc)

confusionMatrix(prediction, testing2$trans_doc)$table
confusionMatrix(prediction, testing2$trans_doc)$overall[1:2]

caret.fit <- train(model, 
                   data = training2, 
                   method = "rpart",
                   control=rpart.control(minsplit = 8, maxdepth = 12),
                   trControl = ctrl,
                   tuneLength=10)
caret.fit

rpart.plot(caret.fit$finalModel)

dtProb <- predict(caret.fit, testing2, type = "prob")

prediction <- as.factor(ifelse(dtProb[,2] > 0.5, "Yes", "No"))

confusionMatrix(prediction, testing2$trans_doc)$table
confusionMatrix(prediction, testing2$trans_doc)$overall[1:2]

```

## Random Forest 

```{r}
rfFit <- train(trans_doc ~ ., 
               data = training2,
               method = "rf",   
               preProc=c('scale','center'),
               tuneLength = 10,
               metric="ROC",
               trControl = ctrl)

plot(rfFit)

rfProb <- predict(rfFit, testing2, type="prob")
prediction <- as.factor(ifelse(rfProb[,2] > 0.5, "Yes", "No"))

confusionMatrix(prediction, testing2$trans_doc)$table
confusionMatrix(prediction, testing2$trans_doc)$overall[1:2]

```


# Conclusions